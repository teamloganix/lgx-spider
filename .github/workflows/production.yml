name: Production Deploy

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -f "VERSION" ]; then
            VERSION=$(cat VERSION | tr -d ' \n')
          else
            VERSION="0.0.0"
          fi
          {
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"
          echo "Deploying version: $VERSION"

      - name: Code style checks and unit tests
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ vars.DEPLOY_PATH }}
            git checkout .
            git pull
            cd backend
            npm i && npm ci
            npm run lint
            npm run format:check
            npm test

      - name: Deploy backend
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ vars.DEPLOY_PATH }}
            git checkout .
            git pull
            export VERSION=${{ steps.version.outputs.version }}
            docker compose up -d --build backend worker
            sleep 10

  e2e-tests:
    needs: deploy-backend
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install system dependencies (Chrome + Xvfb + libs)
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 \
              libxss1 libasound2 fonts-liberation libu2f-udev libvulkan1 \
              libnspr4 libnss3 libxss1 libgconf-2-4 libxrandr2 libasound2 \
              libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 \
              libgdk-pixbuf2.0-0 libxcomposite1 libxcursor1 libxdamage1 \
              libxext6 libxfixes3 libxi6 libxrender1 libxtst6 libxrandr2 \
              libasound2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 \
              libgtk-3-0 libgdk-pixbuf2.0-0
          else
            echo "apt-get not available on this runner; ensure dependencies are installed" && exit 1
          fi
      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      - name: Install frontend deps
        run: cd frontend && npm i && npm ci
      - name: Linting and format check
        run: cd frontend && npm run lint && npm run format:check
      - name: Build frontend (inject API URL)
        env:
          STL_V2_BACKEND_URL: ${{ vars.STL_V2_BACKEND_URL }}
        run: cd frontend && npm run build
      - name: Cypress run against preview server
        uses: cypress-io/github-action@v6
        env:
          STL_V2_BACKEND_URL: ${{ vars.STL_V2_BACKEND_URL }}
          IS_DEV: "true"
          APP_ENV: "dev"
        with:
          working-directory: frontend
          start: npm run preview -- --port 4321
          wait-on: 'http://localhost:4321'
          browser: chrome

  deploy-frontend:
    needs: e2e-tests
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -f "VERSION" ]; then
            VERSION=$(cat VERSION | tr -d ' \n')
          else
            VERSION="0.0.0"
          fi
          {
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"
          echo "Deploying frontend version: $VERSION"

      - name: Deploy frontend
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ vars.DEPLOY_PATH }}
            git checkout .
            git pull
            export VERSION=${{ steps.version.outputs.version }}
            docker compose up -d --build frontend
