name: Staging Update

on:
  push:
    branches:
      - dev

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Code style checks and unit tests
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            git checkout .
            git pull
            cd backend
            npm i && npm ci
            npm run lint
            npm run format:check
            npm test

      - name: Deploy backend
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            git checkout .
            git pull
            docker compose up -d --build backend worker
            # give backend a moment to start
            sleep 10

  e2e-tests:
    needs: deploy-backend
    runs-on: self-hosted
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install system dependencies (Chrome + Xvfb + libs)
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 \
              libxss1 libasound2 fonts-liberation libu2f-udev libvulkan1 \
              libnspr4 libnss3 libxss1 libgconf-2-4 libxrandr2 libasound2 \
              libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 \
              libgdk-pixbuf2.0-0 libxcomposite1 libxcursor1 libxdamage1 \
              libxext6 libxfixes3 libxi6 libxrender1 libxtst6 libxrandr2 \
              libasound2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 \
              libgtk-3-0 libgdk-pixbuf2.0-0
          else
            echo "apt-get not available on this runner; ensure dependencies are installed" && exit 1
          fi
      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      - name: Install frontend deps
        run: cd frontend && npm i && npm ci
      - name: Linting and format check
        run: cd frontend && npm run lint && npm run format:check
      - name: Build frontend (inject API URL)
        env:
          STL_V2_BACKEND_URL: ${{ vars.STL_V2_BACKEND_URL }}
          #VERSION: ${{ github.sha }}
        run: cd frontend && npm run build
      - name: Cypress run against preview server
        uses: cypress-io/github-action@v6
        env:
          STL_V2_BACKEND_URL: ${{ vars.STL_V2_BACKEND_URL }}
          IS_DEV: "true"
          APP_ENV: "dev"
          #VERSION: ${{ github.sha }}
        with:
          working-directory: frontend
          start: npm run preview -- --port 4321
          wait-on: 'http://localhost:4321'
          browser: chrome

  deploy-frontend:
    needs: e2e-tests
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy frontend
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            git checkout .
            git pull
            docker compose up -d --build frontend

  # e2e-tests:
  #   runs-on: ubuntu-latest
  #   environment: staging
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: npm
  #     - run: cd frontend && npm ci
  #     - run: cd frontend && npm run build
  #     - name: Cypress run
  #       uses: cypress-io/github-action@v6
  #       with:
  #         start: cd frontend && npm run preview
  #         wait-on: 'http://localhost:4321'
  #         browser: chrome
